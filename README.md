# tapis-vaultbackup

Backup program for Hashicorp Vault instances that use the raft backend storage.  This utility program runs as a daemon the host on which Vault runs and periodically takes a snapshot of the local raft storage.  See the *VaultBackupParms.java* file for a list of available parameters or simply issue *VaultBackup -help*.  For implementation details, see *VaultBackup.java*.

The build instructions below are tailored for the Red Hat/Centos flavor of Linux, but they can be adapted to other Linux types without too much work.
 
## Building VaultBackup 

1.Build the tapis-vaultbackup JAR

Using **Java 17** or higher, issue "mvn clean install" in the top-level directory of the cloned tapis-vaultbackup repo.  The *tapis-vaultbackup-1.0.jar* file will be created (with the version number subject to change).

2.Install Java 17+ on VM

Login as root on the VM.  Create the /root/pkgs directory and cd into pkgs.  Copy the openjdk 17 tarball in to pkgs and unpack it.  Put the Java executables on the path:  export PATH=$PATH:/root/pkgs/jdk-17/bin 

3.Build Backup Program RPM

Still as root, create directory /root/vaultBackupPackage.  Copy *tapis-vaultbackup-1.0.jar* and the LICENSE file from the tapis-vaultbackup repo into this new directory.  Follow the directions in the attached README.vaultBackupPackage to generate *tapis-vaultbackup-1.0-1.x86_64.rpm*.  Copy the readme file to /root for future reference.

4.Install Backup Program

Still as root, issue "yum install tapis-vaultbackup-1.0-1.x86_64.rpm".  The program will be installed in the /opt/tapis-vaultbackup directory.

5.Create vaultbackup User

Still as root, issue "adduser vaultbackup" with no password.  This is the userid that will run the backup daemon.  Without setting a password, it cannot be logged into directly.

6.Set Up vaultbackup User

Still as root, issue "su - vaultbackup" to switch to the vaultbackup user and its home directory.  Create the /home/vaultbackup/vaultBackups directory.  Copy the attached README.runBackup, listActiveBackups and startVaultBackups files to /home/vaultbackup.

7.Start the Backup Daemon

Read the instruction in README.runBackup to start the deamon.

---

## Files

### /home/vaultbackup/README.runBackup

To start a new instance of tapis-vaultbackup:

1. Run ./listActiveBackups to see if a backup is already running.
    - Only 1 instance of tapis-vaultbackup should be running at time.
    - Kill the tapis-vaultbackup process if you want to start another.

2. See the directions in startVaultBackups.


### /home/vaultbackup/listVaultBackups

    #!/bin/bash
    ps aux | grep tapis-vaultbackup


### /home/vaultbackup/startActiveBackups

    #!/bin/bash
    #
    # Use this file to kick off the perpetual tapis-vaultbackup program that will take
    # a snapshot of the Vault database every specified number of hours (by default
    # period=24).  The procedure is as follows:
    #
    #   1. cd /home/vaultbackup
    #   2. touch token
    #   3. chmod 600 token
    #   4. <paste a root token into /home/vaultbackup/token   
    #   5. Run this script
    #
    # This script will run the tapis-vaultbackup application.  The application will read, 
    # wipe and then delete the token file.  This avoids having the secret easily accessible
    # on this machine; most of the time it's only in memory when tapis-vaultbackup runs.
    #
    # tapis-vaultbackup is a Java application in the tapis-project/tapis-vaultbackup GitHub
    # repository.  An rpm file is generated by the root user using the jpackage utility of
    # Java 17 and installed using yum.  See documentation in the /root directory for details
    # on rpm generation.
    #
    # For application help, type:  /opt/tapis-vaultbackup/bin/tapis-vaultbackup -help


/opt/tapis-vaultbackup/bin/tapis-vaultbackup -url https://tapis-vault-stage.tacc.utexas.edu:8200 -start 2:00 -prefix stage -period 24 -noconsole -smtp-host relay.tacc.utexas.edu -smtp-to cicsupport@tacc.utexas.edu -token /home/vaultbackup/token &


### /root/README.vaultBackupPackage

This is the procedure for building the tapis-vaultbackup RPM.

1. cd /root/vaultBackupPackage
2. Delete all files other than the LICENSE file
3. Copy a prebuilt tapis-vaultbackup-1.0.jar (or later version) into the directory
    - The jar file is built using Java 17 or later
4. Issue this command to build the RPM file:

   jpackage --input . --name tapis-vaultbackup --app-version 1.0 --type rpm --java-options "-Xms50m -Xmx100m" --main-jar tapis-vaultbackup-1.0.jar --main-class edu.utexas.tacc.tapis.vault.backup.VaultBackup

5. Issue "yum remove tapis-vaultbackup" if it currently installed in /opt
6. Issue "yum install tapis-vaultbackup-1.0-1.x86_64.rpm" to install the new version
